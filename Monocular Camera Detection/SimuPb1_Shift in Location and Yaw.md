# 仿真还原：物体位置/航向角抖动

## 1. 问题描述

对于单目相机图像，在感知-追踪-补帧之后结果于仿真中渲染，发现1.部分车辆出现车辆位置抖动出现瞬移情况；2.车辆来回调头，即航向角大偏差。结合原始视频分析，原因如下：

> 问题1基本出现于静止车辆，由于感知算法不考虑时间相关性，产生的检测误差+位姿数据误差，无法保证静止车辆的世界坐标在不同帧之间保持一致性；
> 
> 问题1还有一种产生的情况，比如2辆车a/b由于检测在0帧检测到a，在1帧检测到b，并且a与b位置接近，在追踪模块将两者打上同一标签；
> 
> 问题2主要为感知结果误差(航向角相差180度)；

因此，在感知-追踪模块之后，加入/更新后处理模块。

<div align=center>
<img src="https://github.com/user-attachments/assets/f40c0855-c724-40b5-b694-fb4e16ffee33" width="400px">
</div>

## 2.具体方案

### 2.1 静态物体判断

根据下述条件判断是否为静止物体，对于静止物体固定世界坐标和航向角。

对于平均速度小于等于 $threshold_1$，

$$
   norm(x(0.9) - x(0.1),y(0.9)-y(0.1)) * freq / frames <= threshold_1, 
$$

其中 $x(0.9)$ 表示 $x$ 坐标的0.9分位数(防止突变点)， $freq$ 为帧率， $frames$ 为出现帧数。

对于坐标区域长度小于 $threshold_2$，

$$
   norm(x(0.9) - x(0.1),y(0.9)-y(0.1))  <= threshold_2.
$$

对于平滑后的轨迹(2.2)，如果两帧间角速度大于等于 $threshold_3$，

$$
   max_t(min(abs(yaw_{t+1} - yaw_t), 2\pi - abs(yaw_{t+1} - yaw_t))) * freq >= threshold_3.
$$

### 2.2 轨迹平滑

#### 2.2.1 多项式拟合
对于非静止的动态物体，通过多项式拟合 $x,y,z$，注意1.自变量为帧数；2.帧数不一定连续。

#### 2.2.2 三次样条拟合+滑动平均
对于2.2.1中的平滑方式，发现在nuscense环境车轨迹较为复杂时拟合效果较差，拟合后的位置和原图像车辆的位置不匹配，因此考虑了三次样条拟合+滑动平均。

### 2.3 航向角确定

通过比较平滑后轨迹的航向角(通过坐标计算)与感知-追踪模块后得到的航向角进行比较，确认最终的航向角。
