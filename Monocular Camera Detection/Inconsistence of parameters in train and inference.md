# 感知：训练与推理内外参不一致问题

## 1. 问题描述

对于感知算法，由于训练时相机的内参1(分辨率、 $f_x$、 $f_y$)、外参1(相机坐标到车辆坐标)与推理时的参数2两者往往不一致，将推理时图片通过简单的裁剪、resize、填充后作为模型的输入，
之后通过内外参2进行bbx(车道线)的坐标映射时，会出现整体偏移、物框对应错误的现象。**(下图为resize图片输入模型推理映射后的结果)**

<div align=center>
<img src="https://github.com/user-attachments/assets/141d6632-efd7-4976-9d4d-a87f283885df" width="400px">
</div>

> 上述的问题不可避免，为了使得推理结果更加精确，我们提出了相机映射的方案。

## 2. 相机映射 

相机映射，即根据推理时的图像映射到满足训练时内外参的图像的方法，主要包含2个部分：内参不同和外参不同。

### 2.1 内参不同
为了简化，假设 $f_x=f_y$，内参1包含 $f_1,u_1,v_1$，内参2包含 $f_2,u_2,v_2$，外参两者一致，

$$
u_{train} = f_1 * \frac{x}{z} + u_1, v_{train} = f_1 \frac{y}{z} + v_1, 
$$

$$
u_{eval} = f_2 * \frac{x}{z} + u_2, v_{eval} = f_2 \frac{y}{z} + v_2,
$$

根据上述公式，推理时的情景如果用训练时的相机拍摄，其 $(u_{train},v_{train})$像素点的颜色由推理图像 $(f_2 * \frac{u_{train}-u_1}{f_1} + u_2, f_2 * \frac{v_{train}-v_1}{f_1} + v_2)$位置的像素点决定，
由于运算结果不一定为整数可用双线性插值计算。
